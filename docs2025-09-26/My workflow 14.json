{"createdAt":"2025-09-18T07:23:32.523Z","updatedAt":"2025-09-18T07:23:32.523Z","id":"QSTtiWeYx7hPo5H6","name":"My workflow 14","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-464,224],"id":"3033ca6a-f226-46f5-9616-5c591d8e9bd1","name":"Schedule Trigger"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"log.ai.official@gmail.com","mode":"list","cachedResultName":"log.ai.official@gmail.com"},"returnAll":true,"timeMin":"={{ $now.setZone('Asia/Ho_Chi_Minh').toISO() }}","timeMax":"={{ $now.setZone('Asia/Ho_Chi_Minh').plus({ week: 1 }).toISO() }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[-288,224],"id":"2947b5aa-1b42-4408-a6d0-64c154d26dbc","name":"Get many events","alwaysOutputData":true},{"parameters":{"jsCode":"// ==== CONFIG ====\nconst CHAT_ID = 7706824909;      // chat_id nhận nhắc\nconst WINDOW_MIN = 15;           // nhắc trước bao nhiêu phút\nconst TZ = 'Asia/Ho_Chi_Minh';\nconst TOLERANCE_MS = 2 * 60 * 1000; // ±2 phút quanh mốc 15'\n// =================\n\nconst allItems = $items(\"Get many events\");\nlet events = [];\nallItems.forEach(it => {\n  const data = it.json?.items ?? it.json;\n  if (Array.isArray(data)) events.push(...data.filter(e => e && Object.keys(e).length));\n  else if (data && Object.keys(data).length) events.push(data);\n});\n\nconst now = Date.now();\nconst DUE_MS = WINDOW_MIN * 60 * 1000;\n\nconst due = [];\nfor (const e of events) {\n  if (e.status === 'cancelled') continue;\n\n  // giờ bắt đầu\n  const startIso = e.start?.dateTime\n    || (e.start?.date ? `${e.start.date}T09:00:00+07:00` : null);\n  if (!startIso) continue;\n\n  const dt = new Date(startIso).getTime() - now;\n\n  // chỉ match khi còn trong khoảng 13–15 phút\n  if (dt >= (DUE_MS - TOLERANCE_MS) && dt <= DUE_MS) {\n    due.push({\n      chat_id: CHAT_ID,\n      title: e.summary || 'No title',\n      startIso,\n      location: e.location || '',\n      link: e.hangoutLink || ''\n    });\n  }\n} // <- đóng vòng for\n\nreturn [{\n  json: {\n    eventCount: due.length,   // dùng ở IF: {{$json.eventCount}} > 0\n    due,                      // danh sách event sắp diễn ra\n    windowMinutes: WINDOW_MIN\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,224],"id":"17138ebc-1e7d-4d17-8bd7-a5d6acbd1fab","name":"eventCount"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5fbbecb8-f2de-428b-afca-936812399189","leftValue":"={{ $json.eventCount }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[96,224],"id":"3119063a-9060-4794-8d09-149675ed5a6c","name":"If"},{"parameters":{"jsCode":"const TZ = 'Asia/Ho_Chi_Minh';\nconst data = $json.due || [];            // lấy mảng từ node trước\nconst windowMin = $json.windowMinutes ?? 15;\n\nconst out = data.map(ev => {\n  const startLocal = new Date(ev.startIso).toLocaleTimeString('vi-VN', {\n    hour: '2-digit', minute: '2-digit', timeZone: TZ\n  });\n  // Nếu muốn tính còn bao nhiêu phút chính xác:\n  const minsLeft = Math.max(\n    1,\n    Math.ceil((new Date(ev.startIso).getTime() - Date.now()) / 60000)\n  );\n\n  const text = [\n    `👋 Hi Sếp, **${minsLeft} phút nữa** là:`,\n    `🗓 ${startLocal} — ${ev.title}${ev.location ? ` • ${ev.location}` : ''}`,\n    ev.link ? `🔗 ${ev.link}` : null,\n  ].filter(Boolean).join('\\n');\n\n  return { json: { chat_id: ev.chat_id, text } };\n});\n\nreturn out.length ? out : [{ json: { chat_id: 0, text: 'Không có dữ liệu để gửi.' } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[560,128],"id":"1869c0f6-7d71-4f83-a838-35fce11b59c0","name":"Code"},{"parameters":{"chatId":"=","text":"=📭 Hôm nay chưa thấy lịch làm việc nào trong Google Calendar.\n🗓 Nếu cần, sếp có thể mở Calendar để kiểm tra hoặc thêm lịch mới.","additionalFields":{"appendAttribution":false}},"id":"103a4b86-9cfa-4de5-ba74-3beae29c6af2","name":"TL 2","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[576,304],"webhookId":"682ca5ab-d30c-4ea5-bb25-c2f26206e761","credentials":{"telegramApi":{"id":"gt1FN3MTo3HeK0aI","name":"Telegram account"}}},{"parameters":{"chatId":"=","text":"={{ $json.text }}","additionalFields":{"appendAttribution":false}},"id":"9d674730-c18f-48e1-9d03-d79d364fcf94","name":"TL 1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[736,128],"webhookId":"682ca5ab-d30c-4ea5-bb25-c2f26206e761","credentials":{"telegramApi":{"id":"gt1FN3MTo3HeK0aI","name":"Telegram account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"1f8a2da5-db39-4de8-9ebd-543a0a6ddc72","leftValue":"={{ ['08:30','17:00'].includes($now.setZone('Asia/Ho_Chi_Minh').toFormat('HH:mm')) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[320,320],"id":"276d92e6-e317-4339-a8ef-4fe14c6fb48a","name":"IF B"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Get many events","type":"main","index":0}]]},"Get many events":{"main":[[{"node":"eventCount","type":"main","index":0}]]},"eventCount":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Code","type":"main","index":0}],[{"node":"IF B","type":"main","index":0}]]},"Code":{"main":[[{"node":"TL 1","type":"main","index":0}]]},"IF B":{"main":[[{"node":"TL 2","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"47af940c-ace9-41b8-9b58-8d5aa6b90cc9","triggerCount":0,"shared":[{"createdAt":"2025-09-18T07:23:32.531Z","updatedAt":"2025-09-18T07:23:32.531Z","role":"workflow:owner","workflowId":"QSTtiWeYx7hPo5H6","projectId":"Jvyf4AcH7qn2Ye7v"}],"tags":[]}